<div class="loading-overlay-scoped" *ngIf="isLoading">
    <div class="bouncing-dots-loader">
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
    </div>
</div>

<div class="container-fluid py-4">
    <!-- Toast container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1200">
        <div *ngIf="successMessage" class="toast align-items-center text-bg-success border-0 show" role="alert"
            aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    {{ successMessage }}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" (click)="clearSuccess()"></button>
            </div>
        </div>

        <div *ngIf="errorMessage" class="toast align-items-center text-bg-danger border-0 show" role="alert"
            aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    {{ errorMessage }}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" (click)="clearError()"></button>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Profile Header Card -->
        <div class="col-12 mb-4">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <div class="profile-avatar-large">
                                <i class="bi bi-person-circle fs-1"></i>
                            </div>
                        </div>
                        <div class="col">
                            <h4 class="mb-1">{{ currentUser?.fullName }}</h4>
                            <p class="text-muted mb-1">
                                <i class="bi bi-envelope me-2"></i>{{ currentUser?.email }}
                            </p>
                            <p class="text-muted mb-0">
                                <i class="bi bi-shield-check me-2"></i>{{ currentUser?.roleName }}
                            </p>
                        </div>
                        <div class="col-auto">
                            <span class="badge" [class.bg-success]="currentUser?.isActive"
                                [class.bg-danger]="!currentUser?.isActive"
                                style="font-size: 0.9rem; padding: 0.5rem 1rem;">
                                {{ currentUser?.isActive ? 'ACTIVE' : 'INACTIVE' }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Edit Form -->
        <div class="col-lg-8 mb-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">
                        <i class="bi bi-person-lines-fill me-2"></i>Profile Information
                    </h5>
                </div>
                <div class="card-body p-4">
                    <form #profileForm="ngForm" (ngSubmit)="updateProfile()">
                        <div class="row g-3">
                            <!-- Username -->
                            <div class="col-md-6">
                                <label for="userName" class="form-label fw-semibold">
                                    Username <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="userName" name="userName"
                                    [(ngModel)]="profileData.userName" required readonly
                                    style="background-color: #f8f9fa;" />
                                <small class="text-muted">Username cannot be changed</small>
                            </div>

                            <!-- Email -->
                            <div class="col-md-6">
                                <label for="email" class="form-label fw-semibold">
                                    Email <span class="text-danger">*</span>
                                </label>
                                <input type="email" class="form-control" id="email" name="email"
                                    [(ngModel)]="profileData.email" required
                                    [class.is-invalid]="!isValidEmail(profileData.email) && profileData.email" />
                                <div class="invalid-feedback">
                                    Please enter a valid email address.
                                </div>
                            </div>

                            <!-- First Name -->
                            <div class="col-md-6">
                                <label for="fullName" class="form-label fw-semibold">First Name</label>
                                <input type="text" class="form-control" id="fullName" name="fullName"
                                    [(ngModel)]="profileData.fullName" />
                            </div>

                            <!-- Phone -->
                            <div class="col-md-6">
                                <label for="phone" class="form-label fw-semibold">Phone</label>
                                <input type="text" class="form-control" id="phone" name="phone"
                                    [(ngModel)]="profileData.phone" placeholder="+880 1XXX-XXXXXX" />
                            </div>

                            <!-- Date of Birth -->
                            <div class="col-md-6">
                                <label for="dateOfBirth" class="form-label fw-semibold">Date of Birth</label>
                                <input type="date" class="form-control" id="dateOfBirth" name="dateOfBirth"
                                    [(ngModel)]="profileData.dateOfBirth" />
                            </div>

                            <!-- Country -->
                            <div class="col-md-6">
                                <label for="country" class="form-label fw-semibold">Country</label>
                                <input type="text" class="form-control" id="country" name="country"
                                    [(ngModel)]="profileData.country" placeholder="Bangladesh" />
                            </div>

                            <!-- Location -->
                            <div class="col-md-6">
                                <label for="location" class="form-label fw-semibold">Location</label>
                                <input type="text" class="form-control" id="location" name="location"
                                    [(ngModel)]="profileData.location" placeholder="Dhaka" />
                            </div>

                            <!-- Submit Button -->
                            <div class="col-12 mt-4">
                                <button type="submit" class="btn btn-primary px-4"
                                    [disabled]="!profileForm.valid || isLoading">
                                    <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2"></span>
                                    <i class="bi bi-save me-2" *ngIf="!isLoading"></i>
                                    Update Profile
                                </button>
                                <button type="button" class="btn btn-secondary px-4 ms-2" (click)="resetProfileForm()"
                                    [disabled]="isLoading">
                                    <i class="bi bi-arrow-clockwise me-2"></i>
                                    Reset
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Change Password Card -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">
                        <i class="bi bi-key-fill me-2"></i>Change Password
                    </h5>
                </div>
                <div class="card-body p-4">
                    <form #passwordForm="ngForm" (ngSubmit)="changePassword()">
                        <!-- Current Password -->
                        <div class="mb-3">
                            <label for="currentPassword" class="form-label fw-semibold">
                                Current Password <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <input [type]="showCurrentPassword ? 'text' : 'password'" class="form-control"
                                    id="currentPassword" name="currentPassword"
                                    [(ngModel)]="passwordData.currentPassword" required />
                                <button class="btn btn-outline-secondary" type="button"
                                    (click)="showCurrentPassword = !showCurrentPassword">
                                    <i [ngClass]="showCurrentPassword ? 'fa fa-eye-slash' : 'fa fa-eye'"></i>
                                </button>

                            </div>
                        </div>

                        <!-- New Password -->
                        <div class="mb-3">
                            <label for="newPassword" class="form-label fw-semibold">
                                New Password <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <input [type]="showNewPassword ? 'text' : 'password'" class="form-control"
                                    id="newPassword" name="newPassword" [(ngModel)]="passwordData.newPassword" required
                                    minlength="6" [class.is-invalid]="newPassword.invalid && newPassword.touched"
                                    #newPassword="ngModel" />
                                <button class="btn btn-outline-secondary" type="button"
                                    (click)="showNewPassword = !showNewPassword">
                                    <i [ngClass]="showNewPassword ? 'fa fa-eye-slash' : 'fa fa-eye'"></i>
                                </button>
                            </div>
                            <small class="text-muted">Minimum 6 characters</small>
                            <div class="invalid-feedback d-block" *ngIf="newPassword.invalid && newPassword.touched">
                                Password must be at least 6 characters long.
                            </div>
                        </div>

                        <!-- Confirm Password -->
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label fw-semibold">
                                Confirm New Password <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <input [type]="showConfirmPassword ? 'text' : 'password'" class="form-control"
                                    id="confirmPassword" name="confirmPassword"
                                    [(ngModel)]="passwordData.confirmPassword" required
                                    [class.is-invalid]="passwordData.newPassword !== passwordData.confirmPassword && confirmPassword.touched"
                                    #confirmPassword="ngModel" />

                                <button class="btn btn-outline-secondary" type="button"
                                    (click)="showConfirmPassword = !showConfirmPassword">
                                    <i [ngClass]="showConfirmPassword ? 'fa fa-eye-slash' : 'fa fa-eye'"></i>
                                </button>

                            </div>
                            <div class="invalid-feedback d-block"
                                *ngIf="passwordData.newPassword !== passwordData.confirmPassword && confirmPassword.touched">
                                Passwords do not match.
                            </div>
                        </div>

                        <!-- Password Strength Indicator -->
                        <div class="mb-3" *ngIf="passwordData.newPassword">
                            <small class="text-muted">Password Strength:</small>
                            <div class="progress" style="height: 5px;">
                                <div class="progress-bar" [class.bg-danger]="getPasswordStrength() === 'Weak'"
                                    [class.bg-warning]="getPasswordStrength() === 'Medium'"
                                    [class.bg-success]="getPasswordStrength() === 'Strong'"
                                    [style.width]="getPasswordStrengthWidth()"></div>
                            </div>
                            <small [class.text-danger]="getPasswordStrength() === 'Weak'"
                                [class.text-warning]="getPasswordStrength() === 'Medium'"
                                [class.text-success]="getPasswordStrength() === 'Strong'">
                                {{ getPasswordStrength() }}
                            </small>
                        </div>

                        <!-- Submit Button -->
                        <button type="submit" class="btn btn-warning w-100"
                            [disabled]="!passwordForm.valid || passwordData.newPassword !== passwordData.confirmPassword || isLoading">
                            <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2"></span>
                            <i class="bi bi-shield-lock me-2" *ngIf="!isLoading"></i>
                            Change Password
                        </button>
                    </form>
                </div>
            </div>

            <!-- Account Info Card -->
            <div class="card shadow-sm border-0 mt-4">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle-fill me-2"></i>Account Information
                    </h5>
                </div>
                <div class="card-body p-4">
                    <div class="mb-3">
                        <small class="text-muted d-block mb-1">Account Status</small>
                        <span class="badge" [class.bg-success]="currentUser?.isActive"
                            [class.bg-danger]="!currentUser?.isActive">
                            {{ currentUser?.isActive ? 'Active' : 'Inactive' }}
                        </span>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted d-block mb-1">Role</small>
                        <strong>{{ currentUser?.roleName }}</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>